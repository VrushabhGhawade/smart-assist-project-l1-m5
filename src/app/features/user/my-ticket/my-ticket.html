<div>
    @if (userTickets$ | async; as tickets) {
    @if (getFeedbackPendingCount(tickets) > 0) {
    <div class="feedback-card">
        <mat-icon>warning</mat-icon>
        <p>Feedback awaited</p>
    </div>
    }
    }
    <!-- Filter Chips -->
    <div class="filter-bar">
        <mat-chip-listbox #chipList (click)="onFilterChange(chipList.value)">
            <mat-chip-option value="OPEN">Open</mat-chip-option>
            <mat-chip-option value="CLOSED">Closed</mat-chip-option>
        </mat-chip-listbox>
    </div>

    <!-- Tickets Table -->
    <div class="ticket-card">
        @if (filteredTickets$ | async; as tickets) {
        <table mat-table [dataSource]="tickets" class="mat-elevation-z1">

            <!-- Description -->
            <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef> Ticket </th>
                <td mat-cell *matCellDef="let ticket">
                    <button mat-button color="primary" (click)="onTicketSelcted(ticket.ticketId)">
                       {{ ticket.title }}
                    </button>
                    
                </td>
            </ng-container>

            <!-- Priority -->
            <ng-container matColumnDef="priority">
                <th mat-header-cell *matHeaderCellDef> Priority </th>

                <td mat-cell *matCellDef="let ticket" [ngClass]="getPriorityClass(ticket.priority)"
                    [ngStyle]="getPriorityStyle(ticket.priority)">
                    {{ ticketPriority[ticket.priority] | uppercase }}
                </td>
            </ng-container>


            <!-- Status -->
            <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef> Status </th>
                <td mat-cell *matCellDef="let ticket"> {{ ticketStatus[ticket.status] | ticketStatus }} </td>
            </ng-container>

            <!-- Age -->
            <ng-container matColumnDef="age">
                <th mat-header-cell *matHeaderCellDef> Age </th>
                <td mat-cell *matCellDef="let ticket"> {{ ticket.createdAt | age }} </td>
            </ng-container>

            <!-- Assignee -->
            <ng-container matColumnDef="assignee">
                <th mat-header-cell *matHeaderCellDef> Assignee </th>
                <td mat-cell *matCellDef="let ticket">
                    {{ getByUserName(ticket.assignedToUserId)}}
                </td>
            </ng-container>
            <!-- action -->
            <ng-container matColumnDef="action">
                <th mat-header-cell *matHeaderCellDef> Rating </th>
                <td mat-cell *matCellDef="let ticket">
                    @if (ticket.status === ticketStatus.Resolved && !ticket.rating) {
                    <button mat-button color="primary" (click)="viewTicketDetails(ticket)">
                        <mat-icon>warning</mat-icon>
                        awaited feedback
                    </button>
                    }
                    @if(ticket.rating || ticket.feedback) {
                    <span class="rating-section">
                        @for (item of stars; track $index) {
                        <mat-icon [class.active]="$index < ticket.rating">
                            star
                        </mat-icon>
                        }
                    </span>

                    @if (ticket.feedback) {
                    <mat-icon [matTooltip]="ticket.feedback" color="primary">comment</mat-icon>
                    }
                    }
                </td>
            </ng-container>



            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns" appInteractiveRow></tr>
        </table>
        }
        <!-- âœ… Reactive Empty State -->
        @if ((filteredTickets$ | async)?.length === 0) {
        <p class="no-data">
            No tickets found for this user.
        </p>
        }
    </div>
</div>